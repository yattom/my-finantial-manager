# 個人向け金融資産マネジメントシステム ビジネス仕様書

## 1. システム概要

本システムは、個人投資家が保有する株式、投資信託、ETF等の金融資産を一元管理し、パフォーマンス分析を行うためのWebアプリケーションである。日本市場を主要対象とし、Yahoo Finance APIを活用した価格情報の取得と履歴管理を行う。

## 2. データベース論理設計

### 2.1 エンティティ関係図

```
Asset (資産)
├─ id (主キー)
├─ name (資産名)
├─ ticker (銘柄コード)
├─ type (資産種別)
├─ quantity (数量)
├─ purchase_price (購入価格)
├─ purchase_date (購入日)
├─ current_price (現在価格)
├─ current_value (現在価値：計算項目)
├─ performance (パフォーマンス：計算項目)
└─ last_updated (最終更新日時)

PriceHistory (価格履歴)
├─ id (主キー)
├─ asset_id (外部キー → Asset.id)
├─ date (日付)
├─ price (価格)
└─ value (価値：quantity × price)
```

### 2.2 テーブル仕様

**Assetテーブル**
- 主エンティティとして金融資産の基本情報と現在状況を管理
- `current_value` = `quantity × current_price`で自動計算
- `performance` = `((current_price - purchase_price) / purchase_price) × 100`で自動計算
- インデックス：name, ticker, type

**PriceHistoryテーブル**
- 価格変動の時系列データを保存
- Assetとの1対多関係（CASCADE DELETE）
- 日付インデックスによる高速な期間検索をサポート

### 2.3 データ制約

- 主キーはすべて自動採番
- 外部キー制約：PriceHistory.asset_id → Asset.id
- 必須項目：すべてのカラムがNOT NULL
- 通貨：日本円（JPY）固定

## 3. 株式・資産データの保存方式

### 3.1 資産情報の管理

**保存データ**
- 基本情報：名称、銘柄コード、資産種別（株式、投資信託、ETF、債券、その他）
- 取得情報：数量、購入価格、購入日
- 現在情報：現在価格、現在価値、パフォーマンス
- システム情報：最終更新日時

**価格データの取得**
- Yahoo Finance API（yfinance ライブラリ）による自動取得
- 日本市場銘柄には「.T」サフィックスを付与
- 手動トリガーによる価格更新（自動更新なし）

### 3.2 履歴データの管理

**価格履歴の記録**
- 価格更新時に自動的にPriceHistoryテーブルに記録
- 日付、価格、その時点での総価値を保存
- 時系列分析用のベースデータとして活用

## 4. 可能な操作と制限事項

### 4.1 現在サポートされている操作

**資産管理**
- 新規資産の登録（手動入力）
- 資産情報の更新（数量、購入価格等の修正）
- 資産の削除（関連する価格履歴も同時削除）
- 資産一覧の表示と検索

**価格管理**
- 選択した資産の一括価格更新
- Yahoo Finance APIからのリアルタイム価格取得
- 価格履歴の自動記録

**分析機能**
- ポートフォリオ全体のサマリー表示
- 資産配分の可視化（円グラフ）
- 期間指定でのパフォーマンス分析
- 個別資産のパフォーマンス比較

### 4.2 現在不可能な操作

**履歴関連の制限**
- 過去データの手動修正・削除
- 過去の取引履歴の詳細管理（売買履歴なし）
- 株式分割、配当等の企業行動への対応
- データのバックアップ・復元機能

**システム制限**
- 複数通貨への対応
- リアルタイム価格の自動更新
- ユーザー認証・マルチテナント対応
- データの監査証跡機能

**外部データ制限**
- Yahoo Finance以外のデータソース利用不可
- APIエラー時の代替データ取得なし
- 銘柄コードの妥当性チェックなし

## 5. ユーザー行動とデータ更新パターン

### 5.1 典型的なユーザーワークフロー

**初期セットアップ段階**
1. 保有資産の登録（銘柄コード、数量、購入価格・日付の入力）
2. 初回価格更新による現在価値の算出
3. ポートフォリオ全体の確認

**日常的な利用段階**
1. 定期的な価格更新（週次～月次）
2. パフォーマンス分析の確認
3. 資産配分の見直し

**資産変更時**
1. 新規購入時の資産追加
2. 売却時の数量減少・資産削除
3. 追加購入時の平均取得価格の更新（手動計算）

### 5.2 ユーザーのデータ更新タイミング

**価格更新の必要性**
- 投資判断を行う前
- 月次・四半期レポート作成時
- 市場の大幅変動時
- 税務申告準備時

**資産情報の更新タイミング**
- 新規購入・売却の実行後
- 株式分割等の企業行動発生時（手動対応）
- 配当再投資時の数量調整

### 5.3 ユーザーが得られる情報と意思決定支援

**リアルタイム情報**
- 現在のポートフォリオ評価額
- 個別銘柄のパフォーマンス（含み損益）
- 資産配分の可視化

**過去分析情報**
- 期間指定でのパフォーマンス推移
- 複数銘柄の比較分析
- ポートフォリオ全体の成長軌跡

**意思決定支援**
- 資産配分の偏りの把握
- パフォーマンスの優劣比較
- 投資戦略の効果測定

### 5.4 想定されるユーザーニーズ

**情報把握ニーズ**
- 「現在の資産がどれくらいの価値があるか知りたい」
- 「どの銘柄が好調/不調かを把握したい」
- 「資産配分が適切かを確認したい」

**分析ニーズ**
- 「過去6ヶ月のパフォーマンスを確認したい」
- 「複数銘柄の成績を比較したい」
- 「投資戦略の効果を測定したい」

**管理ニーズ**
- 「新しく購入した銘柄を登録したい」
- 「売却した銘柄を整理したい」
- 「最新の価格情報に更新したい」

## 6. 技術的制約とビジネス影響

### 6.1 スケーラビリティ制約
- SQLiteによる単一ユーザー制限
- 大量データ処理時のパフォーマンス課題
- 同時アクセス処理の制限

### 6.2 外部依存性リスク
- Yahoo Finance APIの可用性依存
- 日本市場データの取得制限
- APIレート制限による更新頻度制約

### 6.3 データ整合性リスク
- 手動データ入力によるエラーリスク
- 価格更新失敗時の不整合
- 履歴データの欠損可能性